<script lang="ts">
import { onMount, tick } from 'svelte';
import gsap from 'gsap';
import Button from './Button.svelte';

export let menuItems: any[] | null;
export let header: any;

let menuWrapper: HTMLElement;
let menuItemsEls: HTMLElement[] = [];
let menuButton: HTMLElement;
let closeButton: HTMLElement;

let tl: gsap.core.Timeline;

onMount(() => {
    let cleanup: (() => void) | undefined;

    const init = async () => {
        if (window.innerWidth >= 992) return; // Only animate on mobile

        await tick();

        tl = gsap.timeline({ paused: true });

        // Animate menu wrapper
        tl.to(menuWrapper, {
            top: 0,
            duration: 0.6,
            ease: "power3.out"
        });

        // Animate menu items
        tl.from(
            menuItemsEls,
            {
                opacity: 0,
                y: 30,
                stagger: 0.08,
                duration: 0.4,
                ease: "power3.out"
            },
            "-=0.3"
        );

        const openMenu = () => tl.play();
        const closeMenu = () => tl.reverse();

        menuButton.addEventListener("click", openMenu);
        closeButton.addEventListener("click", closeMenu);

        // Close menu when clicking any menu link
        const handleLinkClick = () => closeMenu();

        menuItemsEls.forEach((li) => {
            const link = li.querySelector('a');
            if (link) link.addEventListener('click', handleLinkClick);
        });

        cleanup = () => {
            menuButton.removeEventListener("click", openMenu);
            closeButton.removeEventListener("click", closeMenu);
            menuItemsEls.forEach((li) => {
                const link = li.querySelector('a');
                if (link) link.removeEventListener('click', handleLinkClick);
            });
        };
    };

    init();

    return () => {
        if (cleanup) cleanup();
    };
});
</script>

<header class="header">
    <div class="container--full-width">
        <div class="flex justify-between align-center">
        <div class="col">
            <a href="/" class="brand" title="Santiago Estate & Vineyard">
                <svg xmlns="http://www.w3.org/2000/svg" width="93" height="48" viewBox="0 0 93 48" fill="none">
                    <g clip-path="url(#clip0_2105_87)">
                        <path d="M16.9087 47.2227C14.8918 47.2227 13.1584 46.9623 11.7085 46.4454C10.2586 45.9286 9.08818 45.4118 8.19718 44.8909C7.30618 44.3741 6.71083 44.1136 6.41113 44.1136C6.08713 44.1136 5.85628 44.2642 5.71858 44.5653C5.57683 44.8665 5.45938 45.2287 5.36623 45.6519C5.27309 46.0751 5.14754 46.4332 4.99769 46.7344C4.84784 47.0355 4.60079 47.1861 4.25654 47.1861C3.99734 47.1861 3.79079 47.1006 3.62879 46.9256C3.46679 46.7507 3.34529 46.4821 3.26024 46.1158L0.716842 36.2106C0.631793 35.885 0.647993 35.6083 0.765442 35.3682C0.882892 35.1322 1.10564 34.9572 1.42559 34.8514C1.72529 34.7456 2.00069 34.7618 2.24774 34.9002C2.49479 35.0426 2.69324 35.2827 2.84309 35.6287C3.91634 37.8506 5.19614 39.6616 6.67438 41.0655C8.15668 42.4695 9.76048 43.5032 11.4898 44.1747C13.2192 44.8421 14.9728 45.1798 16.7548 45.1798C19.3752 45.1798 21.4042 44.4473 22.842 42.9782C24.2797 41.5132 25.0087 39.6331 25.033 37.346C25.0533 35.942 24.7495 34.6235 24.1137 33.3823C23.4819 32.1411 22.3033 30.9446 20.5861 29.7889C18.8689 28.6332 16.366 27.4733 13.0815 26.3095C9.92653 25.1659 7.39123 23.9044 5.47963 22.5207C3.56804 21.1412 2.17889 19.5866 1.30814 17.8611C0.437393 16.1357 0.00404358 14.2026 0.00404358 12.0661C0.00404358 9.60814 0.562943 7.47571 1.68074 5.67291C2.79854 3.87011 4.35374 2.47427 6.35038 1.48131C8.34298 0.496482 10.6393 0 13.2394 0C15.3657 0 17.0829 0.248241 18.391 0.744722C19.6992 1.2412 20.7319 1.73769 21.4812 2.23417C22.2345 2.73065 22.8217 2.97889 23.251 2.97889C23.6803 2.97889 23.9638 2.73472 24.0408 2.25045C24.1177 1.76617 24.2028 1.27376 24.3 0.777279C24.3972 0.280797 24.6928 0.0325562 25.1869 0.0325562C25.4664 0.0325562 25.6851 0.118016 25.8471 0.293006C26.0091 0.467995 26.1549 0.76914 26.2804 1.20051L29.5001 11.6226C29.6054 11.9888 29.5973 12.3144 29.4677 12.5952C29.3381 12.876 29.1235 13.0713 28.8238 13.1771C28.5241 13.2626 28.2487 13.2463 28.0016 13.1283C27.7546 13.0103 27.5359 12.7783 27.3415 12.4324C26.1184 9.86452 24.7738 7.82569 23.3158 6.3159C21.8538 4.8061 20.2986 3.71547 18.6462 3.04807C16.9938 2.38067 15.2644 2.0429 13.4622 2.0429C10.7568 2.0429 8.58193 2.82425 6.93763 4.39101C5.29333 5.95371 4.47524 8.03323 4.47524 10.6215C4.47524 12.1109 4.80734 13.5067 5.47558 14.8131C6.13978 16.1194 7.31023 17.3646 8.98693 18.5489C10.6636 19.7372 13.0329 20.9133 16.1068 22.0772C19.4562 23.3306 22.1049 24.641 24.0448 26.0083C25.9888 27.3797 27.3658 28.8733 28.1839 30.4889C28.9979 32.1085 29.407 33.9317 29.407 35.9583C29.3867 38.0093 28.8967 39.8854 27.9409 41.5905C26.9851 43.2956 25.5838 44.6589 23.737 45.6844C21.8902 46.71 19.6141 47.2227 16.9087 47.2227Z" fill="#231F20"/>
                        <path d="M64.3017 1.58726C64.731 1.58726 65.0469 1.66458 65.2535 1.81515C65.456 1.96572 65.5613 2.1692 65.5613 2.42965C65.5613 2.66568 65.4641 2.85695 65.2697 2.99531C65.0753 3.13774 64.7877 3.24762 64.3989 3.33715L61.2764 3.75631C60.7377 3.86619 60.4178 4.05746 60.3084 4.33825C60.1991 4.61905 60.2882 5.14809 60.5676 5.92537L73.2887 41.6965L85.5318 6.80031C85.8558 5.85211 85.9247 5.15216 85.7424 4.69637C85.5602 4.24465 85.0175 3.91909 84.1143 3.72375L81.2793 3.33715C80.9148 3.25169 80.6273 3.13774 80.4248 2.99531C80.2223 2.85695 80.117 2.66568 80.117 2.42965C80.117 2.1692 80.2263 1.96572 80.441 1.81515C80.6556 1.66458 80.9675 1.58726 81.3765 1.58726H91.6837C92.1535 1.58726 92.4937 1.65644 92.6962 1.79887C92.8987 1.9413 93.004 2.13664 93.004 2.39709C93.004 2.59243 92.923 2.75928 92.761 2.89764C92.599 3.04007 92.2831 3.18251 91.8093 3.33308L90.327 3.75224C89.7883 3.94758 89.3469 4.26093 88.9905 4.6923C88.6381 5.12367 88.2858 5.85618 87.9456 6.89391L75.4473 42.2703C75.2975 42.722 75.18 43.1167 75.0909 43.4504C75.0059 43.7841 74.9613 44.1341 74.9613 44.5044V45.7009C74.9613 46.0915 74.8682 46.3845 74.6859 46.5921C74.5037 46.7996 74.2283 46.9014 73.8638 46.9014H69.8057C69.4209 46.9014 69.1293 46.7996 68.9349 46.5921C68.7405 46.3886 68.6433 46.0915 68.6433 45.7009V44.5044C68.6433 44.1382 68.6069 43.8045 68.5299 43.4993C68.453 43.1981 68.3315 42.7993 68.1614 42.3028L54.9949 5.37598C54.8005 4.85915 54.5858 4.48476 54.3509 4.26093C54.1403 4.05746 53.8447 3.89874 53.4923 3.77259C53.4194 3.75224 53.3465 3.72782 53.2736 3.71155C52.5446 3.54877 51.6536 3.46737 50.6006 3.46737H38.1347V23.3063H48.28C49.6124 23.3063 50.5277 23.054 51.034 22.5453C51.5402 22.0366 51.844 21.064 51.9533 19.6152C51.9979 19.249 52.087 18.9682 52.2287 18.7728C52.3664 18.5775 52.577 18.4595 52.8565 18.4188C53.4154 18.3089 53.7799 18.6263 53.95 19.3589L56.3354 28.2915C56.4205 28.6374 56.4164 28.9182 56.3192 29.1338C56.222 29.3495 56.0236 29.5001 55.7239 29.5856C55.4647 29.6507 55.2176 29.6303 54.9827 29.5204C54.7478 29.4106 54.5413 29.2193 54.3712 28.9385C53.8973 27.9252 53.4518 27.1601 53.0347 26.6392C52.6175 26.1183 52.1437 25.7724 51.6172 25.5893C51.0907 25.4062 50.4305 25.3126 49.6367 25.3126H38.1388V42.2418C38.1388 43.0842 38.4223 43.7149 38.9933 44.1341C39.5603 44.5533 40.4675 44.7649 41.7149 44.7649H51.5726C52.8808 44.7649 53.9824 44.5451 54.8734 44.1015C55.7644 43.658 56.6189 42.7749 57.433 41.4482C58.2511 40.1216 59.1825 38.1112 60.2355 35.4131C60.3651 35.112 60.5312 34.9004 60.7337 34.7823C60.9362 34.6643 61.167 34.6155 61.4262 34.6358C61.7705 34.6806 62.0094 34.8149 62.1512 35.0387C62.2889 35.2666 62.3051 35.584 62.1998 35.9951L59.7212 46.645C59.6119 47.0967 59.4418 47.4385 59.2069 47.6624C58.972 47.8903 58.6601 48.0042 58.2713 48.0042C57.9068 48.0042 57.5585 47.9025 57.2224 47.6949C56.8862 47.4874 56.5339 47.2839 56.1613 47.0804C55.7846 46.877 55.327 46.7711 54.7924 46.7711H29.2167C28.8076 46.7711 28.5079 46.6898 28.3135 46.527C28.1191 46.3642 28.0219 46.1648 28.0219 45.9288C28.0219 45.4323 28.3743 45.1067 29.083 44.9561L31.4968 44.5695C32.0111 44.4841 32.408 44.3009 32.6875 44.0202C32.9669 43.7394 33.1046 43.3853 33.1046 42.9499V5.27831C33.1046 4.84694 32.9629 4.49289 32.6875 4.20803C32.408 3.92723 32.0111 3.7441 31.4968 3.65864L29.083 3.27204C28.3743 3.12147 28.0219 2.7959 28.0219 2.29942C28.0219 2.03897 28.1191 1.8355 28.3135 1.68492C28.5079 1.53435 28.8076 1.45703 29.2167 1.45703L64.3058 1.58726H64.3017Z" fill="#231F20"/>
                    </g>
                    <defs>
                        <clipPath id="clip0_2105_87">
                        <rect width="93" height="48" fill="white"/>
                        </clipPath>
                    </defs>
                </svg>
            </a>
        </div>

        <div class="col flex align-center">
            <div class="header__menu-wrapper" bind:this={menuWrapper}>
            <ul class="header__menu flex flex-column md:flex-row">
                {#each menuItems as item, i}
                    <li class="header__menu__item" bind:this={menuItemsEls[i]}>
                        <a href={item.url} target={item.target}>
                            {@html item.title.rendered}
                        </a>
                    </li>
                {/each}
                <div class="menu-close" bind:this={closeButton}>
                    <!-- Close icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <rect x="8.2218" y="22.364" width="20" height="2" transform="rotate(-45 8.2218 22.364)" fill="black"/>
                        <rect width="20" height="2" transform="matrix(-0.707107 -0.707107 -0.707107 0.707107 23.7782 22.364)" fill="black"/>
                    </svg>
                </div>
            </ul>
            </div>

            {#if header?.header_button.url}
                <Button
                    type="button"
                    label={header?.header_button?.title}
                    url={header?.header_button?.url}
                    target={header?.header_button?.target}
                />
            {/if}

            <div class="menu-button" bind:this={menuButton}>
            <!-- Hamburger icon SVG -->
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                <rect x="6" y="15" width="20" height="2" fill="black"/>
                <rect x="6" y="7" width="20" height="2" fill="black"/>
                <rect x="6" y="23" width="20" height="2" fill="black"/>
            </svg>
            </div>
        </div>
        </div>
    </div>
</header>

<style lang="scss">

@use '$lib/styles/abstracts' as a;

.header {
    position: sticky;
    top: 0;
    background-color: a.$clr-lighter-tan;
    padding-block: 1rem;
    z-index: 9999;

    &__menu-wrapper {
        display: none;
        position: fixed;
        width: 100%;
        height: 100%;
        top: -100%;
        left: 0;
        background-color: a.$clr-white;
        z-index: 999;
        padding: a.$gap-1;

        @media (min-width: 992px) {
            position: relative;
            background-color: transparent;
            top: 0;
            padding: 0;
        }
    }

    &__menu {
        list-style: none;
        margin: 0;
        padding: 0;

        &__item {
            padding: a.$gap-1;
            font-size: a.$fs-xl;
            text-transform: uppercase;
            letter-spacing: a.$ls;

            @media (min-width: 992px) {
                padding: a.$gap-0_5;
                font-size: a.$fs-sm;
            }

            a {
                color: inherit;
                text-decoration: none;
            }
        }
    }
}

.menu-button {
    display: none;

    @media (min-width: 992px) {
        display: none;
    }
}

.menu-close {
    display: block;
    position: absolute;
    top: 1rem;
    right: 1rem;

    @media (min-width: 992px) {
        display: none;
    }
}

</style>